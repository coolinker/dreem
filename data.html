<html>
<head>
  <title>rhes.es</title>
  <style type="text/css">
    body {
      background-color: rgb(46,36,30);
      background-image: url(img/x2/background-r.png);
      background-size: 259px 259px;
    }
    @font-face {
      font-family: 'wildride';
      src: url('fonts/WildRide.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    .trans {
      background-color: rgba(255,255,255,.5);
      width: 80%;
      height: 80%;
      display:none;
    }
    #logo {
      background-repeat: no-repeat;
      width:171;
      height:64;
      position: absolute;
      background-image: url(img/x2/rheses-color.png);
      background-repeat: no-repeat;
      background-size: 171px 64px;
    }
    #slogan {
      font-family: wildride;
      white-space: nowrap;
      color: rgb(154,123,75);
      font-size: 72px;
      position: absolute;
      text-shadow: 0px 0px 4px rgb(46,36,30);
    }
  </style>
  <script type="text/javascript" src="lib/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="lib/acorn.js"></script>
  <script type="text/javascript" src="lib/coffee-script.js"></script>
  <script type="text/javascript" src="lib/jsonpath-0-8-0.js"></script>
  <script type="text/javascript" src="layout.js"></script>
</head>
<body>
  <view id="container" y="300" width="100" height="100" background-color="purple" border-radius="4px" clip="true">
    <handler name="onclick">
      if (this.bnd) this.bnd.destroy()
      this.setAttribute('clip', false)
      // console.log('onclick', this)
    </handler>

    <class name="simplelayout" extends="layout" type="coffee">
      <attribute name="attribute" type="string" value="x"></attribute>
      <attribute name="inset" type="number" value="0"></attribute>
      <attribute name="spacing" type="number" value="15"></attribute>
      <attribute name="axis" type="string" value="width"></attribute>
      <handler name="oninit">
        # console.log('oninit', this)
      </handler>
      <handler name="oninset" args="inset">
        # console.log('oninset', inset)
        @update()
      </handler>
      <handler name="onsubview" args="subview">
        # console.log('onsubview', @axis, @update, subview, this)
        @listenTo(subview, @axis, @update)
      </handler>
      <setter name="spacing" args="spacing">
        # console.log('spacing setter', spacing, this)
        @update()
      </setter>
      <setter name="attribute" args="attr">
        newaxis = switch attr
          when 'x' then 'width' 
          when 'y' then 'height'

        # console.log 'coffee', attr, arguments, @, @parent 
        unless @skip() 
          for subview in @parent.subviews
            @stopListening(subview, @axis, @update)
            @listenTo(subview, newaxis, @update)

        @axis = newaxis

        # console.log('set_attribute', attr, typeof attr, @attribute, @axis, newaxis)
        @update()
      </setter>
      <method name="update" args="value, sender">
        # console.log('skip', @skip(), @locked)
        return if @skip()
        pos = @inset
        skip = true if sender
        for subview in @parent.subviews
          continue if subview.ignorelayout
          if (skip and subview != sender)
            # console.log 'skipping', subview, sender
          else 
            # console.log 'updating', subview, @attribute, pos
            subview.setAttribute(@attribute, pos) unless subview[@attribute] == pos
            skip = false
          # console.log 'value', pos, @spacing, @inset, @attribute, @axis, subview, subview[@axis]
          pos += @spacing + subview[@axis] 
        return pos
      </method>
    </class>

    <!-- Set the parent's width/height to match the bounds of all its children -->
    <class name="boundslayout" extends="layout" type="coffee">
      <attribute name="width" type="number" value="0"></attribute>
      <attribute name="height" type="number" value="0"></attribute>
      <handler name="oninit">
        # console.log('oninit', this)
      </handler>
      <handler name="onsubview" args="subview">
        # console.log('onsubview bound', @update, subview, this)
        @listenTo(subview, 'x y width height', @update)
      </handler>
      <method name="update" args="value, sender, attribute">
        # console.log('skip', @skip, @locked)
        return if @skip()
        @locked = true
        # TODO: fix to track outliers (and maybe thresholds) and update everything when all outliers go below that threshold
        if false # and sender? and value? and (@lastlength == @parent.subviews.length)
          # update based on sender attribute where available
          if (! attribute or attribute == 'x' or attribute == 'width')
            width = Math.max(@width, sender.x + sender.width)
            #if width != @width
            @setAttribute('width', width) unless @.width == width
            @parent.setAttribute('width', width) unless @parent.width == width

          if (! attribute or attribute == 'y' or attribute == 'height')
            height = Math.max(@height, sender.y + sender.height)
            #if height != @height
            @setAttribute('height', height) unless @.height == height
            @parent.setAttribute('height', height unless @parent.height == height)

          # console.log('sender', value, sender, attribute, width, height)
        else
          # console.log('brute force update')
          width = 0
          height = 0
          for subview, len in @parent.subviews
            continue if subview.ignorelayout
            # console.log 'updating', subview, @attribute, pos
            width = Math.max(width, subview.x + subview.width)
            height = Math.max(height, subview.y + subview.height)
            # return if isNaN(width) or isNaN(height)
            # console.log 'value', subview, width, height

          @lastlength = len

          @setAttribute('width', width) unless @.width == width
          @setAttribute('height', height) unless @.height == height
          @parent.setAttribute('width', width) unless @parent.width == width
          @parent.setAttribute('height', height) unless @parent.height == height
        @locked = false
      </method>
    </class>

    <class name="text" type="coffee">
      <attribute name="multiline" value="false" type="boolean"></attribute>
      <method name="updateSize">
        @set(@sprite.measureTextSize(@multiline, @width))
      </method>
      <handler name="ondata" args="d">
        @setAttribute('text', d)
      </handler>
      <setter name="text" args="text">
        # console.log('set_text', text)
        @sprite.text(text)
        @updateSize() if (text != @text)
      </setter>
      <handler name="oninit">
        # console.log('oninit', @)
        @updateSize()
      </handler>
    </class>

    <class name="inputtext" type="coffee" clickable="true">
      <attribute name="multiline" value="false" type="boolean"></attribute>
      <method name="updateSize">
        @set(@sprite.measureTextSize(@multiline, @width))
      </method>
      <handler name="ondata" args="d">
        @setAttribute('text', d)
      </handler>
      <setter name="text" args="text">
        # console.log('set_text', text)
        @sprite.value(text)
        # @updateSize() if (text != @text)
      </setter>
      <handler name="oninit">
        # el = @sprite.el
        # Prefer text attribute, fall back to innerHTML
        text = @text || @sprite.text()
        # clear innerHTML
        @sprite.text('')
        @sprite.createInputtextElement(text, @multiline, @width)
        @updateSize()
      </handler>
      <handler name="onchange">
        return unless @replicator
        @replicator.updateData(@text)
      </handler>
    </class>

    <class name="replicator" type="coffee" extends="node">
      <attribute name="data" value="[]" type="expression"></attribute>
      <attribute name="classname" value="" type="string"></attribute>
      <attribute name="datapath" value="" type="string"></attribute>
      <handler name="oninit" method="applyData"></handler>
      <handler name="onclassname" method="applyData"></handler>
      <handler name="ondata" method="applyData"></handler>
      <handler name="ondatapath" method="applyData"></handler>
      <method name="updateData" args="data">
        @dataset.updateData(@parsedpath, data);
      </method>
      <method name="applyData">
        return unless @parent
        # console.log('applyData', @data, @classname)

        if @datapath
          re = /^\$([^\.]+)/
          match = @datapath.match(re)
          if match and match[1]
            # absolute datapath
            # console.log('evaluating datapath', @datapath, match[1])
            @dataset = dataset = lz.datasets[match[1]]
            # console.log('listening to dataset', dataset)
            @listenTo(dataset, 'data', (data) =>
              # console.log('callback', @, data)
              @setAttribute('data', data)
            )
            @parsedpath = path = @datapath.replace(re, '$')
            if path == '$'
              # console.log('dataset only', dataset, dataset.data)
              data = [dataset]
            else
              # console.log('evaluating path', path, dataset.data)
              data = jsonPath(dataset.data, path)
          else 
            # relative datapath, look for dataset in parent(s)
            parentdata = @_findInParents('data')
            if parentdata?
              data = jsonPath(parentdata.data, @datapath)
              # console.log('looking for data', @datapath, parentdata.data, data)
            else
              console.warn('No parent datapath found', @datapath, @)
        else
          # no datapath
          data = @data

        return unless data

        if @parent.layouts
          for layout in @parent.layouts
            layout.setAttribute('locked', true)

        if @children
          for child in @children
            child.destroy()
        @children = []

        for datum in data
          child = new lz[@classname](null, {data: datum, parent: @parent, replicator: @})
          # console.log 'created', datum, @classname, child
          child.initConstraints()
          @children.push(child)

        if @parent.layouts
          for layout in @parent.layouts
            layout.setAttribute('locked', false)
      </method>
    </class>

    <simplelayout name="lay" spacing="42" type="coffee">
      <handler name="oninit">
        # console.log('oninit instance', this)
        this.hello('a', 'b', 'c')
      </handler>
      <method name="hello" args="a,b,c">
        # console.log('hello instance', a,b,c, this)
      </method>
    </simplelayout>
    <boundslayout name="bnd"></boundslayout>

    <class name="clickresize" width="10" height="10" bgcolor="red">
      <attribute name="data" value="null"></attribute>
      <handler name="onclick">
        this.animate({width: 100, height: 100})
      </handler>
    </class>

    <clickresize bgcolor="red"></clickresize>
    <clickresize bgcolor="yellow" onclick="this.destroy()"></clickresize>
    <clickresize bgcolor="green"></clickresize>
    <clickresize bgcolor="black"></clickresize>
    <clickresize bgcolor="blue">
      <handler name="onclick" type="coffee">
        if (@subviews.length)
          #console.log('destroy', @, @destroy)
          @destroy()
        else
          lay = new lz.simplelayout(null, {parent: @, locked: true, inset: 15})
          for i of ([0..1000])
            #console.log('creating', i)
            new lz.clickresize(null, {parent: @})
          lay.setAttribute('locked', false)
      </handler>
    </clickresize>
    <text onclick="this.setAttribute('text', 'Hi mum this is a lot wider!')" bgcolor="yellow">Hello</text>
    <text width="100" multiline="true" bgcolor="orange">This text should wrap at my width</text>
    <text text="${this.parent.inp.text}" bgcolor="red"></text>
    <inputtext bgcolor="green" name="inp" onclick="this.setAttribute('text', 'Yooyoyo')">Text</inputtext>

    <view width="10" height="10" bgcolor="cyan" x="${lz.mouse.x - this.parent.getAbsolute().x - (this.width * .5)}" y="${lz.mouse.y - this.parent.getAbsolute().y - (this.width * .5)}" clickable="false" ignorelayout="true">
      <handler name="onclick" reference="lz.mouse">
        if (this.width !== 100)
          this.animate({width: 100, height: 100, opacity: .2}, 1000)
      </handler>
    </view>

    <class name="dataset" type="coffee" extends="node">
      <handler name="oninit">
        lz.datasets ?= {}
        lz.datasets[@name] = @
      </handler>
      <attribute name="url" type="string" value=""></attribute>
      <handler name="ontextcontent">
        if @textcontent
          @setAttribute('data', JSON.parse(@textcontent))
          # console.log('data', @name, @data)
      </handler>
      <handler name="onurl" method="loadURL"></handler>
      <method name="loadURL" args="url">
        # console.log('loading url', url)
        # assume JSONP
        $.ajax({
          url: url,
          dataType: 'jsonp'
        }).done((data) =>
          # console.log('data', url, data)
          @setAttribute('data', data)
        );
      </method>
      <method name="updateData" args="path, data">
        # find the scope and property to be updated
        re = /\.([^\.]+)$/
        property = path.match(re)
        if property and property[1]
          subpath = path.replace(re, '')

          scope = jsonPath(@data, subpath)
          # only handle updating a single field
          return unless scope.length == 1

          # console.log(data, @data, path, scope[0], property[1], scope[0][property[1]])
          scope[0][property[1]] = data
          # TODO: send smaller updates based on path argument
          @sendEvent('data', @data)
      </method>
    </class>

    <dataset name="storedata">
    { "store": {
        "book": [ 
          { "category": "reference",
            "author": "Nigel Rees",
            "title": "Sayings of the Century",
            "price": 8.95
          },
          { "category": "fiction",
            "author": "Evelyn Waugh",
            "title": "Sword of Honour",
            "price": 12.99
          },
          { "category": "fiction",
            "author": "Herman Melville",
            "title": "Moby Dick",
            "isbn": "0-553-21311-3",
            "price": 8.99
          },
          { "category": "fiction",
            "author": "J. R. R. Tolkien",
            "title": "The Lord of the Rings",
            "isbn": "0-395-19395-8",
            "price": 22.99
          }
        ],
        "bicycle": {
          "color": "red",
          "price": 19.95
        }
      }
    }
    </dataset>
    <dataset name="tempdata" url="http://api.openweathermap.org/data/2.5/weather?q=San+Francisco,CA&units=imperial&callback=?"></dataset>

    <replicator datapath="$storedata.store.book[*].author" classname="text"></replicator>
    <replicator datapath="$tempdata.main.temp" classname="inputtext"></replicator>

    <class name="weather">
      <boundslayout></boundslayout>
      <view>
        <simplelayout></simplelayout>
        <boundslayout></boundslayout>
        <replicator datapath="weather[0].main" classname="text"></replicator>
        <replicator datapath="main.temp" classname="text"></replicator>
        <replicator datapath="wind.speed" classname="text"></replicator>
        <replicator datapath="wind.deg" classname="text"></replicator>
      </view>
    </class>
    <replicator datapath="$tempdata" classname="weather"></replicator>
  </view

</body>
</html>