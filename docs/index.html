
<html lang="en">

  <head>
    <title>Dreem in 10</title>
    <script type="text/javascript" src="/lib/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/lib/acorn.js"></script>
    <script type="text/javascript" src="/lib/coffee-script.js"></script>
    <script type="text/javascript" src="/layout.js"></script>

    <style type="text/css">
      html {
        height: 100%;
      }
      body {
        min-height: 100%;
      }
    </style>


  </head>

  <body>

  <view id="all" width="${lz.window.width}" height="${lz.window.height}" clip="true">

    <view name="lesson" width="${this.parent.width/4}" height="${this.parent.height}" bgcolor="#e0e0e0">
      <text text="Execute button" bgcolor="green">
        <handler name="onclick">
          prefix = 
	    ['&lt;view id="all" width="600" height="600" clip="true">'].join('\n');

          // setTimeout added for Firefox
	  postfix = 
	    ['&lt;/view>',
	     '&lt;script>$(function(){setTimeout(function(){window.frames[0].lz.initElements()}, 0);});&lt;/script>'].join('\n');

          contents = this.parent.parent.editor.text;
	  fullcontents = prefix + contents + postfix;
          fullcontents = fullcontents.replace('&lt;', '<');
          this.parent.parent.renderFrame.setAttribute('contents', fullcontents);
        </handler>
      </text>
      <text x="0" y="40" name="description" width="${this.parent.width}" height="${this.parent.height-this.y}" bgcolor="#a0a0a0" multiline="true">
      </text>
    </view>


    <ace name="editor" x="${this.parent.width/4}" width="${this.parent.width/2}" height="${this.parent.height}" text="" bgcolor="#808080">
      <handler name="onwidth">
        // console.log("ace: ", this.width, this.height);
      </handler>
      <handler name="onheight">
        // console.log("ace: ", this.width, this.height);
      </handler>
    </ace>

    <dreem_iframe name="renderFrame" x="${this.parent.width*3/4}" width="${this.parent.width/4}" height="${this.parent.height}" bgcolor="#e0e0e0">
    </dreem_iframe>

    <!-- Split the file into description and code.
         The first comment block is the description.
     -->
    <method name="showLesson" args="contents">
      var description = '';
      var code = contents;
      var p0 = contents.indexOf('/**');
      if (p0 >= 0) {
        var p1 = contents.indexOf('*/', p0);
        if (p1 >= 0) {
          description = contents.substr(p0+3, p1-(p0+3));

          // The code starts at the first newline after the description
          code = contents.substr(p1+2);
          p0 = code.indexOf('\n');
          if (p0 >= 0)
            code = code.substr(p0+1);
        }
      }

      this.lesson.description.setAttribute('text', description);
      this.editor.setAttribute('text', code);
    </method>


    <!-- Given the page name, locate the lesson page and display it. If
         missing, the default page is shown.
    -->
    <method name="renderPage" args="page">
      var $this = this;

      // Retrieve this page, or use the default if missing
      var lesson = 'din10';
      url = "/docs/" + lesson + "/" + page + ".lzx";
      $.ajax({
        type: 'GET',
        url: url,
        success: function(data) {
          $this.showLesson(data);
        },
        error: function() {
          $.get("/docs/" + lesson + "/default.lzx", function(data) {
            $this.showLesson(data);
          });
        }
      });
    </method>


    <handler name="oninit">
      // Page to show comes from the hash attribute. If the page is missing,
      // a default page is shown.
      var page = $(location).attr('hash').replace('#','');
      if (!page) page = 'default';

      this.renderPage (page);
    </handler>

  </view>
  </body>
</html>
