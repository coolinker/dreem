<html>
<head>
  <title>dr33m</title>
  <style type="text/css">
    body {
      background-color: white;
      font-family: 'Helvetica';
      font-size: 40px;
      margin: 0px;
      padding: 0px;
    }
    input {
      font-family: 'Helvetica';
      font-size: 14px;
      margin: 0px;
      padding: 0px;
      width: 100px;
    }
  </style>
  <script type="text/javascript" src="lib/jquery-1.9.1.js"></script>
  <script type="text/javascript" src="lib/acorn.js"></script>
  <script type="text/javascript" src="lib/coffee-script.js"></script>
  <script type="text/javascript" src="lib/json-path+json-ptr-0.1.3.min.js"></script>
  <script type="text/javascript" src="layout.js"></script>
  <script type="text/javascript" src="lib/md5.js"></script>
  <script type="text/javascript" src="lib/shim.js"></script>
</head>
<body>
  <view>
    <shim id="shim">
      <handler name="ondata" args="data">
        if (thumbnailstrip.$view) {
          thumbnailstrip.$view.setAttribute('data', data)
        }
      </handler>
    </shim>

    <class name="genreyear" type="coffee" width="14" height="60" opacity=".13">
      <handler name="onmouseover">
        shim.$view.send(@data)
        cursor.$view.setAttribute('x', this.x)
      </handler>
      <handler name="ondata" args="data">
        if data.genres
          # console.log('genre', data.genres[0])
          color = '#' + md5(data.genres[0].id + '1').substring(0,6)
          this.setAttribute('background-color', color);
      </handler>
    </class>

    <class name="genrestrip">
      <timelayout scale="14" inset="1900"></timelayout>
      <replicator datapath="$topmovies/searchResponse/results[*]/movie[@]" classname="genreyear">
        <handler name="oninit">
          this.filterfunction = function(obj, accum, sel) {
            // console.log('filterfunction', obj, accum, this.parent.parent.data.name)
            if (obj.genres && obj.genres[0].name === this.parent.parent.data.name)
              accum.push(obj);
            return accum;
          }
          this.applyData();
        </handler>
        <method name="filterfunction" args="obj, accum, sel">
        </method>
      </replicator>
    </class>

    <class name="genre" font-size="60" font-weight="bold" color="silver">
      <boundslayout></boundslayout>
      <replicator datapath="/name[@]" classname="text">
        <method name="filterfunction" args="obj, accum, sel">
          // console.log('filterfunction', obj, accum)
          obj = obj.replace('[nf]', '');
          accum.push(obj);
          return accum
        </method>
      </replicator>

      <genrestrip y="9" z-index="1000"></genrestrip>
    </class>

    <class name="thumbtitle" extends="text" multiline="true" width="50" color="silver" font-weight="bold"></class>

    <class name="thumbnail" type="coffee" background-size="cover" transition="all .5s" border-style="solid" border-width="0" border-color="white" width="180" height="240" bgcolor="white" clip="true">
      <handler name="onmouseover">
        this.setAttribute('border-width', 3);
      </handler>
      <handler name="onmouseout">
        this.setAttribute('border-width', 0);
      </handler>
      <handler name="onclick">
        this.parent.setAttribute('height', 0)
        console.log('thumbnail', @data, @)
      </handler>
      <handler name="ondata" args="data">
        if data.images
          for image in data.images
            continue if image.width > 120

          if image.width > 120
            return
          else
            data._title = data.title unless data._title
            data.title = ''

          # image = data.images[0]

          height = image.height * 1.6
          height = 240 if (height > 240)

          this.setAttribute('width', image.width * 1.6);
          this.setAttribute('height', height);
          this.setAttribute('background-image', "url('" + image.url + "')");
      </handler>
      <replicator datapath="/title" classname="thumbtitle"></replicator>
    </class>

    <dataset name="topmovies" url="top_movies.json"></dataset>

    <simplelayout attribute="y" axis="height" spacing="1"></simplelayout>
    <view id="thumbnailstrip" width="${lz.window.width}" height="248" bgcolor="silver" clip="true" position="fixed" z-index="100000">
      <handler name="ondata" args="data">
        this.year.setAttribute('text', data.releaseYear)
        this.repl.applyData();
      </handler>

      <!-- <boundslayout ignoreattr="width"></boundslayout> -->
      <wraplayout></wraplayout>

      <text name="year" font-size="210px" color="white" opacity=".6" font-weight="bold" ignorelayout="true" z-index="1000" x="${this.parent.width - this.width - 10}" text-shadow="0px 0px 10px black"></text>
      <replicator name="repl" datapath="$topmovies/searchResponse/results[*]/movie[@]" classname="thumbnail">
        <method name="filterfunction" args="obj, accum, sel">
          if (this.parent.data && this.parent.data.releaseYear == obj.releaseYear)
            accum.push(obj);
          return accum
        </method>
      </replicator>
    </view>

    <view>
      <simplelayout attribute="y" axis="height" spacing="1"></simplelayout>
      <replicator datapath="$topmovies/searchResponse/facetCounts[0]/facetCount[*][@]" classname="genre" sortfield="count" sortasc="false">
        <method name="filterfunction" args="obj, accum, sel">
          // console.log('filterfunction', obj, accum)
          if (obj.count > 0 && obj.name.indexOf('Culture') == -1)
            accum.push(obj);
          return accum
        </method>
      </replicator>
    <view>

    <view id="cursor" width="14" height="${lz.window.height}" bgcolor="silver" opacity=".4" position="fixed"></view>


    <!-- TODO: workaround for autoincludes don't load for class extends="" -->
    <text display="none">Hello</text>
  </view>
</body>
</html>